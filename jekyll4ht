#!/usr/bin/env texlua
kpse.set_program_name("luatex")


local make4ht = require("make4ht-lib")
local lapp    = require("lapp-mk4")
local mkutils = require("mkutils")
local mkparams = require("mkparams")
-- args string is here just as sample, we dont pass it it to 
-- mkparams.get_args() so default args string is used

local options = {progname = "jekyll4ht"}
local args = mkparams.get_args(options)

local parameters = mkparams.process_args(args) 


-- add to tex4ht_sty_par: imgdir:adresar so obrazky,mod
-- Make:htlatex {packages = '\\RequirePackage{jekyll}'}
-- css soubory kopírovat taky do samostatnýho adresáře, jméno bude ve frontmatter, je věcí 
-- usera dát cestu k css souboru do šablony
local mode = parameters.mode
local build_file = parameters.build_file 

local make = mkutils.load_config(parameters, build_file)["Make"]
make.params = parameters
if make:length() < 1 then
	if mode == "draft" then
		make:htlatex()
	else
		make:htlatex()
		make:htlatex()
		make:htlatex()
	end
end


if not args["no-tex4ht"] then
  make:tex4ht()
end

local ext = args.xetex and "xdv" or "dvi"
if #make.image_patterns > 0 then
  make.params.t4ht_par = make.params.t4ht_par .. " -p"
end
make:t4ht {ext = ext}
make:match("tmp$", function() return false,"tmp file" end)
make:match(".*",function(filename,par)
	local outdir =  '' --par["outdir"] and par["outdir"] .."/" or ''
	if par['outdir'] ~= "" then outdir = par['outdir'] .. '/' end
	print("outdir: "..outdir)
	local outfilename = outdir .. filename
	mkutils.copy(filename,outfilename)
	return true
end)
make:run()
